<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>VC-NFT zk-SSO PoC (Sepolia) â€” Root ë°”ì¸ë”©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Ethers.js v6 (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>

  <!-- snarkjs (ë¸Œë¼ìš°ì € ë²ˆë“¤) -->
  <script src="../zk/snark.min.js"></script>
  <!-- â†‘ ì¦ëª… íŒŒì¼ ì—…ë¡œë“œ/ìƒì„±(ì˜µì…˜)ì—ì„œë§Œ ì‚¬ìš©. fullProve ì‚¬ìš©ì‹œ ../zk/access_control.wasm / .zkey ê²½ë¡œê°€ ìœ íš¨í•´ì•¼ í•¨ -->

  <style>
    :root { --bg:#0f1222; --panel:#171a2b; --ink:#e8ebff; --muted:#aeb4d9; --ok:#67e8a5; --bad:#ff7b7b; --acc:#7c9bff; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui}
    header{padding:22px 18px;border-bottom:1px solid #232749}
    h1{margin:0 0 6px 0;font-size:20px}
    small{color:var(--muted)}
    main{max-width:980px;margin:20px auto;padding:0 18px 60px}
    section{background:var(--panel);border:1px solid #21264a;border-radius:14px;margin:16px 0;padding:16px}
    h2{margin:0 0 12px 0;font-size:17px}
    h3{margin:6px 0 8px 0;font-size:15px}
    .row{display:grid;grid-template-columns:180px 1fr;gap:10px;margin:10px 0}
    input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #2a2f55;background:#10132a;color:var(--ink);font-size:14px}
    .btn{display:inline-flex;align-items:center;gap:8px;background:#1c2250;color:#fff;border:1px solid #2f3a7a;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .hint{color:var(--muted);font-size:13px;margin-top:6px;white-space:pre-line}
    .hr{height:1px;background:#24284b;margin:12px 0}
    .ok{color:var(--ok)} .bad{color:var(--bad)}
    code{background:#10132a;border:1px solid #2a2f55;padding:2px 6px;border-radius:8px}
  </style>
</head>
<body>
  <header>
    <h1>VC-NFT zk-SSO PoC <span class="mono">Sepolia</span> â€” Root ë°”ì¸ë”©</h1>
    <small>ERC-721(SBT ìŠ¤íƒ€ì¼) + ZK ê²€ì¦ í•œ ë²ˆ í˜¸ì¶œë¡œ ë¡œê·¸ì¸/ê²Œì´íŠ¸ (PoC: ë¨¸í´íŒ¨ìŠ¤ ì—†ìŒ)</small>
  </header>

  <main>
    <!-- 0) CONFIG & WALLET -->
    <section>
      <h2>â‘  í™˜ê²½ ì„¤ì • & ì§€ê°‘</h2>
      <div class="row"><div>ì²´ì¸</div><div id="cfgChain" class="mono">-</div></div>
      <div class="row"><div>IdentityNFT</div><div class="mono" id="cfgNFT">-</div></div>
      <div class="row"><div>PolicyVerifier</div><div class="mono" id="cfgPV">-</div></div>
      <div class="hr"></div>
      <div class="row"><div>ì§€ê°‘ ìƒíƒœ</div><div id="walletStatus" class="bad">ë¯¸ì—°ê²°</div></div>
      <div class="row"><div>ê³„ì •</div><div class="mono" id="walletAddr">-</div></div>
      <button class="btn" id="btnConnect">ğŸ¦Š MetaMask ì—°ê²°</button>
      <div class="hint">* Sepoliaë¡œ ì—°ê²° ë° ìˆ˜ìˆ˜ë£Œìš© ETH í•„ìš”.</div>
    </section>

    <!-- 1) POLICY (ê³µê°œ ì •ì±…) + PRIVATE (ë‚´ ì‹ ì›) + SALTS + ROOT ê³„ì‚° -->
    <section>
      <h2>â‘¡ ì„œë¹„ìŠ¤ ì •ì±…(public) & ë‚´ ì‹ ì›(private) & ë£¨íŠ¸ ê³„ì‚°</h2>

      <div class="grid2">
        <div>
          <h3>ì„œë¹„ìŠ¤ ì •ì±… (íšŒë¡œ public)</h3>
          <div class="row"><div>ë‚˜ì´ ê²€ì‚¬</div>
            <div><select id="ageFlag"><option value="1">í™œì„±</option><option value="0">ë¹„í™œì„±</option></select></div>
          </div>
          <div class="row"><div>ìš”êµ¬ ë‚˜ì´</div><div><input id="reqAge" type="number" value="19" min="0" /></div></div>

          <div class="row"><div>ì„±ë³„ ê²€ì‚¬</div>
            <div><select id="genderFlag"><option value="1">í™œì„±</option><option value="0">ë¹„í™œì„±</option></select></div>
          </div>
          <div class="row"><div>ìš”êµ¬ ì„±ë³„</div>
            <div><select id="reqGender"><option value="0">ë‚¨ì„±(0)</option><option value="1">ì—¬ì„±(1)</option></select></div>
          </div>

          <div class="row"><div>êµ­ì  ê²€ì‚¬</div>
            <div><select id="nationFlag"><option value="1">í™œì„±</option><option value="0">ë¹„í™œì„±</option></select></div>
          </div>
          <div class="row"><div>í—ˆìš© êµ­ì  (ìµœëŒ€ 5)</div>
            <div>
              <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px">
                <select class="nationOpt"><option value="410">KOR</option><option value="840">USA</option><option value="392">JPN</option><option value="826">GBR</option><option value="0">â€”</option></select>
                <select class="nationOpt"><option value="0">â€”</option><option value="410">KOR</option><option value="840">USA</option><option value="392">JPN</option><option value="826">GBR</option></select>
                <select class="nationOpt"><option value="0">â€”</option><option value="410">KOR</option><option value="840">USA</option><option value="392">JPN</option><option value="826">GBR</option></select>
                <select class="nationOpt"><option value="0">â€”</option><option value="410">KOR</option><option value="840">USA</option><option value="392">JPN</option><option value="826">GBR</option></select>
                <select class="nationOpt"><option value="0">â€”</option><option value="410">KOR</option><option value="840">USA</option><option value="392">JPN</option><option value="826">GBR</option></select>
              </div>
              <div class="hint">* í•„ìš” ê°œìˆ˜ë§Œ ì„ íƒ, ë‚˜ë¨¸ì§€ëŠ” â€œâ€”(0)â€.</div>
            </div>
          </div>

          <div class="row"><div>ì •ì±… ë¬¸ìì—´</div><div><input id="policyStr" value="age>=19&KRorUS"/></div></div>
        </div>

        <div>
          <h3>ë‚´ ì‹ ì› (íšŒë¡œ private)</h3>
          <div class="row"><div>ë‚˜ì´</div><div><input id="pvAge" type="number" value="23" min="0"/></div></div>
          <div class="row"><div>ì„±ë³„</div>
            <div><select id="pvGender"><option value="0">ë‚¨ì„±(0)</option><option value="1">ì—¬ì„±(1)</option></select></div>
          </div>
          <div class="row"><div>êµ­ì  ì½”ë“œ</div>
            <div><select id="pvNation"><option value="410">KOR(410)</option><option value="840">USA(840)</option><option value="392">JPN(392)</option><option value="826">GBR(826)</option></select></div>
          </div>

          <div class="hr"></div>
          <h3>Salts (PoC, ë¹„ê³µê°œ)</h3>
          <div class="row"><div>salt_age</div><div><input id="saltAge" type="number" value="1111" min="0"/></div></div>
          <div class="row"><div>salt_gender</div><div><input id="saltGender" type="number" value="2222" min="0"/></div></div>
          <div class="row"><div>salt_nation</div><div><input id="saltNation" type="number" value="3333" min="0"/></div></div>

          <div class="row"><div>ê³„ì‚° ë£¨íŠ¸(root)</div><div><input id="calcRoot" class="mono" placeholder="0x..." readonly/></div></div>
          <div class="row"><div></div><div>
            <button class="btn" id="btnCalcRoot">ğŸ§® Poseidonìœ¼ë¡œ ë£¨íŠ¸ ê³„ì‚°</button>
            <span class="hint">leaf=Poseidon(tag,val,salt)\nroot=Poseidon(leafAge,leafGender,leafNation)</span>
          </div></div>
        </div>
      </div>
    </section>

    <!-- 2) MINT -->
    <section>
      <h2>â‘¢ ID-NFT ë¯¼íŒ… (ì˜¤í”ˆ ëª¨ë“œ)</h2>
      <div class="row"><div>ìˆ˜í˜œì ì£¼ì†Œ</div><div><input id="mintTo" placeholder="0x... (ë¯¸ì…ë ¥ ì‹œ ë³¸ì¸)"/></div></div>
      <div class="row"><div>ë§Œë£Œ(ì¼)</div><div><input id="mintDays" type="number" value="30" min="1"/></div></div>
      <div class="row"><div>ì†ì„±ë£¨íŠ¸</div>
        <div class="grid2">
          <input id="mintRoot" class="mono" placeholder="0x00.. (ê³„ì‚° ë£¨íŠ¸ ê¶Œì¥)"/>
          <button class="btn" id="btnUseCalcRoot">â®• ê³„ì‚° ë£¨íŠ¸ ì‚¬ìš©</button>
        </div>
      </div>
      <button class="btn" id="btnMint">ğŸªª ë¯¼íŒ…</button>
      <div id="mintLog" class="mono hint"></div>
    </section>

    <!-- 3) VERIFY -->
    <section>
      <h2>â‘£ ì¦ëª… ìƒì„± & on-chain ê²€ì¦</h2>
      <div class="row"><div>Token ID</div><div><input id="tokenId" type="number" min="1" placeholder="ë¯¼íŒ… ë°›ì€ tokenId"/></div></div>
      <div class="row"><div>ì¦ëª… ìƒì„± ë°©ë²•</div>
        <div><select id="proveMode">
          <option value="browser">ë¸Œë¼ìš°ì €ì—ì„œ ìƒì„±(snarkjs)</option>
          <option value="upload">íŒŒì¼ ì—…ë¡œë“œ(ì´ë¯¸ ìƒì„±í•œ proof/public)</option>
        </select></div>
      </div>

      <div id="uploadPanel" style="display:none">
        <div class="row"><div>public.json</div><div><input id="filePublic" type="file" accept=".json"/></div></div>
        <div class="row"><div>proof.json</div><div><input id="fileProof" type="file" accept=".json"/></div></div>
      </div>

      <div class="row"><div>ì˜¨ì²´ì¸ root</div><div class="mono" id="onchainRoot">-</div></div>

      <button class="btn" id="btnVerify">âœ… verifyAndEmit</button>
      <div id="verifyLog" class="mono hint"></div>
      <div class="hint">* publicSignals ê¸¸ì´ = 11 (ì •ì±… 10 + root 1). nullifierëŠ” PoCë¡œ 0x00â€¦ ì‚¬ìš©.</div>
    </section>
  </main>

  <script>
    /*** CONFIG ***/
    const CHAIN_ID = 11155111; // Sepolia
    const ADDR = {
      IdentityNFT:    "0x20d6E2f83aFd8BAD601d02A232c43EAf94401A79",
      PolicyVerifier: "0x74A572a339C5f3d93c3534064ECc797D684B6A5A",
    };

    /*** ABIs (ë¹Œë“œ ì‚°ì¶œë¬¼ì—ì„œ ë¡œë“œ) ***/
    let ABI_NFT = null;
    let ABI_PV  = null;

    /*** DOM helpers ***/
    const $ = id => document.getElementById(id);
    const log = (el, msg) => { el.textContent = msg; };

    /*** Ethers objects ***/
    let provider, signer, nft, pv, account;

    /*** Poseidon (ESM + ìˆœìˆ˜ JS) ***/
    let poseidon = null;  // function(BigInt[]) -> BigInt
    let F = null;
    let poseidonLoaded = false;

    async function ensurePoseidon() {
      if (poseidonLoaded && poseidon && F) return;
      try {
        // ìˆœìˆ˜ JS êµ¬í˜„: wasm/stream ì˜ì¡´ì„± ì—†ìŒ
        const lib = await import('https://esm.sh/circomlibjs@0.1.7?bundle&target=es2020');
        const p = await lib.buildPoseidonOpt();
        F = p.F;
        poseidon = (arr) => p(arr.map(BigInt));
        poseidonLoaded = true;
      } catch (e) {
        console.error("Poseidon ë¡œë“œ ì‹¤íŒ¨:", e);
        throw new Error("Poseidon ì´ˆê¸°í™” ì‹¤íŒ¨ (poseidon_opt). ë„¤íŠ¸ì›Œí¬/CORSë¥¼ í™•ì¸í•˜ì„¸ìš”.");
      }
    }

    // Poseidon í•´ì‹œ ë˜í¼
    async function H(arr) {
      if (!poseidonLoaded) await ensurePoseidon();
      // p(arr) â†’ BigInt, F.toObjectëŠ” BigInt ìœ ì§€ì— ì•ˆì „
      return F.toObject(poseidon(arr));
    }

    const toHex32 = (v) => {
      const b = BigInt(v);
      const hex = b.toString(16).padStart(64, '0');
      return '0x' + hex;
    };

    // UI ì´ˆê¸°ê°’
    $("cfgChain").textContent = `${CHAIN_ID} (Sepolia)`;
    $("cfgNFT").textContent   = ADDR.IdentityNFT;
    $("cfgPV").textContent    = ADDR.PolicyVerifier;

    async function loadAbis() {
      const [nftJson, pvJson] = await Promise.all([
        fetch("../artifacts/contracts/IdentityNFT.sol/IdentityNFT.json").then(r => r.json()),
        fetch("../artifacts/contracts/PolicyVerifier.sol/PolicyVerifier.json").then(r => r.json()),
      ]);
      ABI_NFT = nftJson.abi;
      ABI_PV  = pvJson.abi;
    }

    /*** Wallet connect ***/
    $("btnConnect").onclick = async () => {
      try {
        if (!window.ethereum) return alert("MetaMask í•„ìš”");
        provider = new ethers.BrowserProvider(window.ethereum);
        const want = "0x" + CHAIN_ID.toString(16);
        const cur  = await provider.send("eth_chainId", []);
        if (cur !== want) {
          try { await provider.send("wallet_switchEthereumChain", [{ chainId: want }]); }
          catch (e){ return alert("Sepolia ë„¤íŠ¸ì›Œí¬ ì„ íƒ/ì¶”ê°€ í•„ìš”: " + (e?.message || e)); }
        }
        await provider.send("eth_requestAccounts", []);
        signer  = await provider.getSigner();
        account = await signer.getAddress();

        await loadAbis();
        nft = new ethers.Contract(ADDR.IdentityNFT, ABI_NFT, signer);
        pv  = new ethers.Contract(ADDR.PolicyVerifier, ABI_PV, signer);

        $("walletAddr").textContent = account;
        $("walletStatus").textContent = "ì—°ê²°ë¨";
        $("walletStatus").className = "ok";
      } catch (e) {
        console.error(e);
        alert("ì§€ê°‘ ì—°ê²° ì‹¤íŒ¨: " + (e?.shortMessage || e?.message || e));
      }
    };

    /*** ë£¨íŠ¸ ê³„ì‚°(PoC) ***/
    $("btnCalcRoot").onclick = async () => {
      try {
        await ensurePoseidon();

        const age     = BigInt($("pvAge").value || "0");
        const gender  = BigInt($("pvGender").value);
        const nation  = BigInt($("pvNation").value);
        const sAge    = BigInt($("saltAge").value || "0");
        const sGender = BigInt($("saltGender").value || "0");
        const sNation = BigInt($("saltNation").value || "0");

        // LeafHash3(tag, val, salt)
        const leafAge    = await H([1n, age,    sAge]);
        const leafGender = await H([2n, gender, sGender]);
        const leafNation = await H([3n, nation, sNation]);
        const root       = await H([leafAge, leafGender, leafNation]);

        $("calcRoot").value = toHex32(root);
      } catch (e) {
        console.error(e);
        alert("ë£¨íŠ¸ ê³„ì‚° ì‹¤íŒ¨: " + (e?.message || e));
      }
    };

    $("btnUseCalcRoot").onclick = () => {
      const r = $("calcRoot").value.trim();
      if (!/^0x[0-9a-fA-F]{64}$/.test(r)) return alert("ë¨¼ì € ë£¨íŠ¸ ê³„ì‚°ì„ í•´ì£¼ì„¸ìš”.");
      $("mintRoot").value = r;
    };

    /*** Mint ***/
    $("btnMint").onclick = async () => {
      if (!signer) return alert("ì§€ê°‘ë¶€í„° ì—°ê²°");
      const to = $("mintTo").value.trim() || account;
      const days = parseInt($("mintDays").value || "30", 10);
      const root = $("mintRoot").value.trim();
      if (!/^0x[0-9a-fA-F]{64}$/.test(root)) return alert("ì†ì„±ë£¨íŠ¸ëŠ” 0x + 64 hex (ê³„ì‚° ë£¨íŠ¸ ì‚¬ìš© ê¶Œì¥)");
      const exp = BigInt(Math.floor(Date.now()/1000) + 86400*days);
      try {
        $("btnMint").disabled = true;
        log($("mintLog"), "ë¯¼íŒ… ì¤‘â€¦");
        const tx = await nft.mint(to, exp, root);
        const rc = await tx.wait();
        const ev = rc.logs?.find(l => l.fragment?.name==="Issued");
        log($("mintLog"), `ì™„ë£Œ: tokenId=${ev?.args?.tokenId?.toString() ?? "(txì—ì„œ í™•ì¸)"} tx=${rc.hash}`);
      } catch(e) {
        console.error(e);
        log($("mintLog"), `ì—ëŸ¬: ${e.shortMessage||e.message||e}`);
      } finally {
        $("btnMint").disabled = false;
      }
    };

    /*** UI toggle for prove mode ***/
    $("proveMode").onchange = () => {
      const mode = $("proveMode").value;
      $("uploadPanel").style.display = (mode === "upload") ? "" : "none";
    };
    $("proveMode").dispatchEvent(new Event("change"));

    /*** calldata parser: snarkjs export â†’ a,b,c,inputs ***/
    function parseSolidityCalldata(calldata) {
      const argv = calldata.replace(/["[\]\s]/g, "").split(",").map(x => BigInt(x).toString());
      const a = [argv[0], argv[1]].map(x => BigInt(x));
      const b = [
        [argv[2], argv[3]].map(x => BigInt(x)),
        [argv[4], argv[5]].map(x => BigInt(x)),
      ];
      const c = [argv[6], argv[7]].map(x => BigInt(x));
      const inputs = argv.slice(8).map(x => BigInt(x).toString());
      return { a, b, c, inputs };
    }

    /*** verify flow ***/
    $("btnVerify").onclick = async () => {
      if (!signer) return alert("ì§€ê°‘ë¶€í„° ì—°ê²°");
      const tokenId = BigInt($("tokenId").value || "0");
      if (tokenId <= 0n) return alert("Token ID ì…ë ¥");

      try {
        const user  = await signer.getAddress();
        let owner;
        try { owner = await nft.ownerOf(tokenId); } catch { return log($("verifyLog"), "ì‹¤íŒ¨: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” tokenId"); }
        if (owner.toLowerCase() !== user.toLowerCase()) return log($("verifyLog"), "ì‹¤íŒ¨: NOT_OWNER");
        if (await nft.revoked(tokenId))                 return log($("verifyLog"), "ì‹¤íŒ¨: REVOKED");
        if (Number(await nft.expiresAt(tokenId)) <= Math.floor(Date.now()/1000))
          return log($("verifyLog"), "ì‹¤íŒ¨: EXPIRED");

        // ì˜¨ì²´ì¸ root ì¡°íšŒ
        const onchainRoot = await nft.attrCommitRoot(tokenId);
        $("onchainRoot").textContent = onchainRoot;

        // ì •ì±…(public)
        const nations = Array.from(document.querySelectorAll(".nationOpt")).map(s => s.value || "0").slice(0,5);
        const publicInputsObj = {
          age_check_flag:           $("ageFlag").value,
          required_age:             $("reqAge").value || "0",
          gender_check_flag:        $("genderFlag").value,
          required_gender:          $("reqGender").value,
          nationality_check_flag:   $("nationFlag").value,
          required_country_codes:   nations
        };

        // private
        const priv = {
          prover_age:           $("pvAge").value || "0",
          prover_gender:        $("pvGender").value,
          prover_country_code:  $("pvNation").value,
          salt_age:             $("saltAge").value || "0",
          salt_gender:          $("saltGender").value || "0",
          salt_nation:          $("saltNation").value || "0",
        };

        // ë£¨íŠ¸ ì¬ê³„ì‚° â†’ ì˜¨ì²´ì¸ rootì™€ ì¼ì¹˜í•´ì•¼ íšŒë¡œê°€ ì„±ë¦½(PoC)
        await ensurePoseidon();
        const leafAge    = await H([1n, BigInt(priv.prover_age),          BigInt(priv.salt_age)]);
        const leafGender = await H([2n, BigInt(priv.prover_gender),       BigInt(priv.salt_gender)]);
        const leafNation = await H([3n, BigInt(priv.prover_country_code), BigInt(priv.salt_nation)]);
        const calcRoot   = toHex32(await H([leafAge, leafGender, leafNation]));

        if (onchainRoot.toLowerCase() !== calcRoot.toLowerCase()) {
          return log($("verifyLog"), `ì‹¤íŒ¨: ë£¨íŠ¸ ë¶ˆì¼ì¹˜\non-chain: ${onchainRoot}\ncalc:    ${calcRoot}`);
        }

        const policyHash = ethers.keccak256(ethers.toUtf8Bytes($("policyStr").value || "poc"));
        const nullifier  = "0x" + "0".repeat(64); // PoC

        $("btnVerify").disabled = true;
        log($("verifyLog"), "ì¦ëª…/ê²€ì¦ ì¤€ë¹„ ì¤‘â€¦");

        let a,b,c,publicSignals;
        if ($("proveMode").value === "upload") {
          const fPub  = $("filePublic").files?.[0];
          const fProof= $("fileProof").files?.[0];
          if (!fPub || !fProof) throw new Error("public.json / proof.json ì—…ë¡œë“œ í•„ìš”");
          const pubObj  = JSON.parse(await fPub.text());
          const prfObj  = JSON.parse(await fProof.text());
          const proof   = prfObj.proof ?? prfObj;
          const pubSigs = pubObj.publicSignals ?? pubObj;
          const calldata = await snarkjs.groth16.exportSolidityCallData(proof, pubSigs);
          const parsed   = parseSolidityCalldata(calldata);
          a = parsed.a; b = parsed.b; c = parsed.c; publicSignals = parsed.inputs;
        } else {
          if (!window.snarkjs) throw new Error("snarkjs ë¡œë“œ ì‹¤íŒ¨");
          const input = {
            // private
            prover_age:           priv.prover_age,
            prover_gender:        priv.prover_gender,
            prover_country_code:  priv.prover_country_code,
            salt_age:             priv.salt_age,
            salt_gender:          priv.salt_gender,
            salt_nation:          priv.salt_nation,
            // public â€” íšŒë¡œ ì„ ì–¸ ìˆœì„œ(ì •ì±…10 + root1)
            age_check_flag:           publicInputsObj.age_check_flag,
            required_age:             publicInputsObj.required_age,
            gender_check_flag:        publicInputsObj.gender_check_flag,
            required_gender:          publicInputsObj.required_gender,
            nationality_check_flag:   publicInputsObj.nationality_check_flag,
            required_country_codes:   publicInputsObj.required_country_codes,
            root:                     onchainRoot
          };

          // ì£¼ì˜: íŒŒì¼ ê²½ë¡œëŠ” http ì„œë²„ì—ì„œ ìœ íš¨í•´ì•¼ í•¨
          const { proof, publicSignals: pubS } = await snarkjs.groth16.fullProve(
            input,
            "../zk/access_control.wasm",
            "../zk/access_control_0001.zkey"
          );

          const calldata = await snarkjs.groth16.exportSolidityCallData(proof, pubS);
          const parsed   = parseSolidityCalldata(calldata);
          a = parsed.a; b = parsed.b; c = parsed.c; publicSignals = parsed.inputs;
        }

        if (publicSignals.length !== 12) {
          return log($("verifyLog"), `ì‹¤íŒ¨: publicSignals length mismatch (${publicSignals.length} != 11)`);
        }

        // íŠ¸xn ì „ ì‹œë®¬
        try {
          await pv.verifyAndEmit.staticCall(tokenId, publicSignals, { a,b,c }, policyHash, nullifier);
        } catch (sim) {
          const msg = sim?.shortMessage || sim?.reason || sim?.message || "staticCall reverted";
          console.warn("staticCall revert:", sim);
          return log($("verifyLog"), `ì‹¤íŒ¨(static): ${msg}`);
        }

        log($("verifyLog"), "verifyAndEmit íŠ¸ëœì­ì…˜ ì „ì†¡â€¦");
        const tx = await pv.verifyAndEmit(tokenId, publicSignals, { a,b,c }, policyHash, nullifier);
        const rc = await tx.wait();
        const ev = rc.logs?.find(l => l.fragment?.name === "Verified");
        log($("verifyLog"), ev ? `ì„±ê³µ: tokenId=${ev.args.tokenId.toString()} tx=${rc.hash}` : `ì™„ë£Œ(tx=${rc.hash})`);
      } catch (e) {
        const msg = e?.shortMessage || e?.reason || e?.message || "execution reverted";
        console.error(e);
        log($("verifyLog"), `ì‹¤íŒ¨: ${msg}`);
      } finally {
        $("btnVerify").disabled = false;
      }
    };
  </script>
</body>
</html>
