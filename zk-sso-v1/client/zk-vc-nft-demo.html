<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>VC-NFT zk-SSO PoC (Sepolia)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Ethers.js v6 -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>
    <!-- (ì„ íƒ) ë¸Œë¼ìš°ì € ì¦ëª… ìƒì„±ì„ ì“°ë ¤ë©´ ì•„ë˜ ë‘ ì¤„ í™œì„±í™”í•˜ê³  ./zk í´ë”ì— íŒŒì¼ ë°°ì¹˜ -->
    <script src="../zk/snark.min.js"></script>
    <script src="../zk/witness_calculator.js"></script>
    <style>
        :root { --bg:#0f1222; --panel:#171a2b; --ink:#e8ebff; --muted:#aeb4d9; --ok:#67e8a5; --bad:#ff7b7b; --acc:#7c9bff; }
        html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui}
        header{padding:22px 18px;border-bottom:1px solid #232749}
        h1{margin:0 0 6px 0;font-size:20px}
        small{color:var(--muted)}
        main{max-width:980px;margin:20px auto;padding:0 18px 60px}
        section{background:var(--panel);border:1px solid #21264a;border-radius:14px;margin:16px 0;padding:16px}
        h2{margin:0 0 12px 0;font-size:17px}
        .row{display:grid;grid-template-columns:180px 1fr;gap:10px;margin:10px 0}
        input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #2a2f55;background:#10132a;color:var(--ink);font-size:14px}
        .btn{display:inline-flex;align-items:center;gap:8px;background:#1c2250;color:#fff;border:1px solid #2f3a7a;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
        .btn:disabled{opacity:.45;cursor:not-allowed}
        .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
        .hint{color:var(--muted);font-size:13px;margin-top:6px}
        .hr{height:1px;background:#24284b;margin:12px 0}
        .ok{color:var(--ok)} .bad{color:var(--bad)}
    </style>
</head>
<body>
    <header>
        <h1>VC-NFT zk-SSO PoC <span class="mono">Sepolia</span></h1>
        <small>ERC-721(SBT ìŠ¤íƒ€ì¼) + ZK ê²€ì¦ í•œ ë²ˆ í˜¸ì¶œë¡œ ë¡œê·¸ì¸/ê²Œì´íŠ¸</small>
    </header>
    <main>
        
        <!-- 0) CONFIG & WALLET -->
        <section>
            <h2>â‘  í™˜ê²½ ì„¤ì • & ì§€ê°‘</h2>
            <div class="row"><div>ì²´ì¸</div><div id="cfgChain" class="mono">11155111 (Sepolia)</div></div>
            <div class="row"><div>IdentityNFT</div><div class="mono" id="cfgNFT">0xYour_NFT</div></div>
            <div class="row"><div>PolicyVerifierA</div><div class="mono" id="cfgPV">0xYour_PV</div></div>
            <div class="hr"></div>
            <div class="row"><div>ì§€ê°‘ ìƒíƒœ</div><div id="walletStatus" class="bad">ë¯¸ì—°ê²°</div></div>
            <div class="row"><div>ê³„ì •</div><div class="mono" id="walletAddr">-</div></div>
            <button class="btn" id="btnConnect">ğŸ¦Š MetaMask ì—°ê²°</button>
            <div class="hint">* Sepoliaì— ì—°ê²°ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. ìˆ˜ìˆ˜ë£Œìš© ETH í•„ìš”.</div>
        </section>
        
        <!-- 1) MINT -->
        <section>
            <h2>â‘¡ ID-NFT ë¯¼íŒ… (ì˜¤í”ˆ ëª¨ë“œ)</h2>
            <div class="row"><div>ìˆ˜í˜œì ì£¼ì†Œ</div><div><input id="mintTo" placeholder="0x... (ë¯¸ì…ë ¥ ì‹œ ë³¸ì¸)"/></div></div>
            <div class="row"><div>ë§Œë£Œ(ì¼)</div><div><input id="mintDays" type="number" value="30" min="1"/></div></div>
            <div class="row"><div>ì†ì„±ë£¨íŠ¸</div><div><input id="mintRoot" placeholder="0x00.. (PoCëŠ” 0x00 ê¶Œì¥)"/></div></div>
            <button class="btn" id="btnMint">ğŸªª ë¯¼íŒ…</button>
            <div id="mintLog" class="mono hint"></div>
        </section>
        
        <!-- 2) POLICY (ì„œë¹„ìŠ¤ê°€ ìš”êµ¬í•˜ëŠ” ê³µê°œ ì •ì±…) -->
        <section>
            <h2>â‘¢ ì„œë¹„ìŠ¤ ì •ì±…(ê³µê°œ ì…ë ¥) & ë‚´ ì‹ ì›(ë¹„ê³µê°œ ì…ë ¥)</h2>
            
            <div class="grid2">
                <div>
                    <h3>ì„œë¹„ìŠ¤ ì •ì±… (íšŒë¡œ public)</h3>
                    <div class="row"><div>ë‚˜ì´ ê²€ì‚¬</div>
                    <div>
                        <select id="ageFlag">
                            <option value="1">í™œì„±(ê²€ì‚¬)</option>
                            <option value="0">ë¹„í™œì„±(ë¬´ì‹œ)</option>
                        </select>
                    </div>
                </div>
                <div class="row"><div>ìš”êµ¬ ë‚˜ì´</div><div><input id="reqAge" type="number" value="19" min="0" /></div></div>
                
                <div class="row"><div>ì„±ë³„ ê²€ì‚¬</div>
                <div>
                    <select id="genderFlag">
                        <option value="1">í™œì„±</option>
                        <option value="0">ë¹„í™œì„±</option>
                    </select>
                </div>
            </div>
            <div class="row"><div>ìš”êµ¬ ì„±ë³„</div>
            <div>
                <select id="reqGender">
                    <option value="0">ë‚¨ì„±(0)</option>
                    <option value="1">ì—¬ì„±(1)</option>
                </select>
            </div>
        </div>
        
        <div class="row"><div>êµ­ì  ê²€ì‚¬</div>
        <div>
            <select id="nationFlag">
                <option value="1">í™œì„±</option>
                <option value="0">ë¹„í™œì„±</option>
            </select>
        </div>
    </div>
    <div class="row"><div>í—ˆìš© êµ­ì  (ìµœëŒ€ 5)</div>
    <div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr 1fr;gap:6px">
            <select class="nationOpt">
                <option value="410">KOR(410)</option><option value="840">USA(840)</option><option value="392">JPN(392)</option><option value="826">GBR(826)</option><option value="0">â€”</option>
            </select>
            <select class="nationOpt">
                <option value="0">â€”</option><option value="410">KOR</option><option value="840">USA</option><option value="392">JPN</option><option value="826">GBR</option>
            </select>
            <select class="nationOpt">
                <option value="0">â€”</option><option value="410">KOR</option><option value="840">USA</option><option value="392">JPN</option><option value="826">GBR</option>
            </select>
            <select class="nationOpt">
                <option value="0">â€”</option><option value="410">KOR</option><option value="840">USA</option><option value="392">JPN</option><option value="826">GBR</option>
            </select>
            <select class="nationOpt">
                <option value="0">â€”</option><option value="410">KOR</option><option value="840">USA</option><option value="392">JPN</option><option value="826">GBR</option>
            </select>
        </div>
        <div class="hint">* í•„ìš” ê°œìˆ˜ë§Œ ì„ íƒí•˜ê³  ë‚˜ë¨¸ì§€ëŠ” â€œâ€”(0)â€ë¡œ ë‘ì„¸ìš”.</div>
    </div>
</div>

<div class="row"><div>ì •ì±… ë¬¸ìì—´</div><div><input id="policyStr" value="age>=19&KRorUS"/></div></div>
</div>

<div>
    <h3>ë‚´ ì‹ ì› (íšŒë¡œ private)</h3>
    <div class="row"><div>ë‚˜ì´</div><div><input id="pvAge" type="number" value="23" min="0"/></div></div>
    <div class="row"><div>ì„±ë³„</div>
    <div>
        <select id="pvGender">
            <option value="0">ë‚¨ì„±(0)</option>
            <option value="1">ì—¬ì„±(1)</option>
        </select>
    </div>
</div>
<div class="row"><div>êµ­ì  ì½”ë“œ</div>
<div>
    <select id="pvNation">
        <option value="410">KOR(410)</option>
        <option value="840">USA(840)</option>
        <option value="392">JPN(392)</option>
        <option value="826">GBR(826)</option>
    </select>
</div>
</div>

<div class="hr"></div>
<div class="row"><div>Token ID</div><div><input id="tokenId" type="number" min="1" placeholder="ë¯¼íŒ… ë°›ì€ tokenId"/></div></div>

<div class="row"><div>ì¦ëª… ìƒì„± ë°©ë²•</div>
<div>
    <select id="proveMode">
        <option value="browser">ë¸Œë¼ìš°ì €ì—ì„œ ìƒì„±(snarkjs, wasm/zkey í•„ìš”)</option>
        <option value="upload">íŒŒì¼ ì—…ë¡œë“œ(ì´ë¯¸ ìƒì„±í•œ proof/public)</option>
    </select>
</div>
</div>

<div id="uploadPanel" style="display:none">
    <div class="row"><div>public.json</div><div><input id="filePublic" type="file" accept=".json"/></div></div>
    <div class="row"><div>proof.json</div><div><input id="fileProof" type="file" accept=".json"/></div></div>
</div>

<button class="btn" id="btnVerify">âœ… verifyAndEmit</button>
<div id="verifyLog" class="mono hint"></div>
</div>
</div>
<div class="hint">* PoC: ì†ì„±ë£¨íŠ¸/ë„ë¦¬íŒŒì´ì–´ ë°”ì¸ë”©ì€ ìƒëµ. ERC-721+ê²€ì¦ 1íšŒ í˜¸ì¶œë¡œ ë.</div>
</section>
</main>

<script>
    /*** CONFIG ***/
    const CHAIN_ID = 11155111; // Sepolia
    const ADDR = {
        // ğŸ‘‰ ë°°í¬í•œ ì£¼ì†Œë¡œ êµì²´
        IdentityNFT:    "0x2B8b514A79B8a4E892BF01D6c678a77c336F3AB3",
        PolicyVerifierA:"0x0507ABC7Ee6B2Cddf25E3Fe3858F5f5cD1a26A9A",
    };
    
    /*** Minimal ABIs ***/
    let ABI_NFT = null
    let ABI_PV = null
    
    /*** DOM helpers ***/
    const $ = id => document.getElementById(id);
    const log = (el, msg) => el.textContent = msg;
    
    /*** Ethers objects ***/
    let provider, signer, nft, pv, account;
    
    /*** Wallet connect ***/
    $("cfgChain").textContent = `${CHAIN_ID} (Sepolia)`;
    $("cfgNFT").textContent  = ADDR.IdentityNFT;
    $("cfgPV").textContent   = ADDR.PolicyVerifierA;
    
    async function loadAbis() {
        // Hardhat ë¹Œë“œ ì‚°ì¶œë¬¼ ìœ„ì¹˜ ì˜ˆì‹œ:
        //  - artifacts/contracts/IdentityNFT.sol/IdentityNFT.json
        //  - artifacts/contracts/PolicyVerifierA.sol/PolicyVerifierA.json
        const [nftJson, pvJson] = await Promise.all([
        fetch("../artifacts/contracts/IdentityNFT.sol/IdentityNFT.json").then(r => {
            if (!r.ok) throw new Error(`NFT ABI fetch failed: ${r.status}`);
            return r.json();
        }),
        fetch("../artifacts/contracts/PolicyVerifier.sol/PolicyVerifier.json").then(r => {
            if (!r.ok) throw new Error(`PV ABI fetch failed: ${r.status}`);
            return r.json();
        }),
        ]);
        ABI_NFT = nftJson.abi;
        ABI_PV  = pvJson.abi;
    }
    
    $("btnConnect").onclick = async () => {
        if (!window.ethereum) return alert("MetaMask í•„ìš”");
        provider = new ethers.BrowserProvider(window.ethereum);
        const want = "0x" + CHAIN_ID.toString(16);
        const cur = await provider.send("eth_chainId", []);
        if (cur !== want) {
            try { await provider.send("wallet_switchEthereumChain", [{ chainId: want }]); }
            catch (e){ return alert("Sepolia ë„¤íŠ¸ì›Œí¬ë¥¼ ì„ íƒ/ì¶”ê°€í•˜ì„¸ìš”: " + e.message); }
        }
        await provider.send("eth_requestAccounts", []);
        signer = await provider.getSigner();
        account = await signer.getAddress();
        
        await loadAbis();
        nft = new ethers.Contract(ADDR.IdentityNFT, ABI_NFT, signer);
        pv  = new ethers.Contract(ADDR.PolicyVerifierA, ABI_PV, signer);
        $("walletAddr").textContent = account;
        $("walletStatus").textContent = "ì—°ê²°ë¨";
        $("walletStatus").className = "ok";
        
        // ì˜¤í”ˆ ëª¨ë“œ ì„¤ì • (ìµœì´ˆ 1íšŒë§Œ ì‹¤í–‰)
        // const tx = await nft.setOpenIssuerMode(true);
        // await tx.wait();
        
    };
    
    /*** Mint ***/
    $("btnMint").onclick = async () => {
        if (!signer) return alert("ì§€ê°‘ë¶€í„° ì—°ê²°");
        const to = $("mintTo").value.trim() || account;
        const days = parseInt($("mintDays").value || "30", 10);
        let root = $("mintRoot").value.trim();
        if (!root) root = "0x" + "0".repeat(64);
        if (!/^0x[0-9a-fA-F]{64}$/.test(root)) return alert("ì†ì„±ë£¨íŠ¸ëŠ” 0x + 64 hex");
        const exp = BigInt(Math.floor(Date.now()/1000) + 86400*days);
        try {
            $("btnMint").disabled = true;
            log($("mintLog"), "ë¯¼íŒ… ì¤‘â€¦");
            const tx = await nft.mint(to, exp, root);
            const rc = await tx.wait();
            const ev = rc.logs?.find(l => l.fragment?.name==="Issued");
            log($("mintLog"), `ì™„ë£Œ: tokenId=${ev?.args?.tokenId?.toString() ?? "(txì—ì„œ í™•ì¸)"} tx=${rc.hash}`);
        } catch(e) {
            log($("mintLog"), `ì—ëŸ¬: ${e.shortMessage||e.message}`);
        } finally {
            $("btnMint").disabled = false;
        }
    };
    
    /*** UI toggle for prove mode ***/
    $("proveMode").onchange = () => {
        const mode = $("proveMode").value;
        $("uploadPanel").style.display = (mode === "upload") ? "" : "none";
    };
    $("proveMode").dispatchEvent(new Event("change"));
    
    /*** Build public/private inputs from UI ***/
    function buildInputsFromUI() {
        // public (ì •ì±…)
        const ageFlag = $("ageFlag").value;
        const reqAge  = $("reqAge").value || "0";
        const genderFlag = $("genderFlag").value;
        const reqGender  = $("reqGender").value; // 0/1
        const nationFlag = $("nationFlag").value;
        
        const nations = Array.from(document.querySelectorAll(".nationOpt")).map(s => s.value || "0");
        // ê¸¸ì´ 5 ë³´ì¥
        while (nations.length < 5) nations.push("0");
        
        const publicInputs = {
            age_check_flag: ageFlag,
            required_age: reqAge,
            gender_check_flag: genderFlag,
            required_gender: reqGender,
            nationality_check_flag: nationFlag,
            required_country_codes: nations.slice(0,5)
        };
        
        // private (ë‚´ ì‹ ì›)
        const priv = {
            prover_age: $("pvAge").value || "0",
            prover_gender: $("pvGender").value,     // 0/1
            prover_country_code: $("pvNation").value
        };
        
        return { publicInputs, priv };
    }
    
    /*** File JSON helper ***/
    async function readJson(fileInput) {
        const f = fileInput.files?.[0];
        if (!f) return null;
        const txt = await f.text();
        return JSON.parse(txt);
    }
    // ê³µí†µ íŒŒì„œ: snarkjs calldata -> a,b,c,inputs
    function parseSolidityCalldata(calldata) {
        const argv = calldata.replace(/["[\]\s]/g, "").split(",").map(x => BigInt(x).toString());
        const a = [argv[0], argv[1]].map(x => BigInt(x));
        const b = [
        [argv[2], argv[3]].map(x => BigInt(x)),
        [argv[4], argv[5]].map(x => BigInt(x)),
        ];
        const c = [argv[6], argv[7]].map(x => BigInt(x));
        const inputs = argv.slice(8).map(x => BigInt(x).toString());
        return { a, b, c, inputs };
    }
    
    $("btnVerify").onclick = async () => {
        if (!signer) return alert("ì§€ê°‘ë¶€í„° ì—°ê²°");
        const tokenId = BigInt($("tokenId").value || "0");
        if (tokenId <= 0n) return alert("Token ID ì…ë ¥");
        
        // on-chain ìƒíƒœ ë¹ ë¥¸ ì²´í¬
        const user  = await signer.getAddress();
        const owner = await nft.ownerOf(tokenId);
        if (owner.toLowerCase() !== user.toLowerCase()) return log($("verifyLog"), "ì‹¤íŒ¨: NOT_OWNER");
        if (await nft.revoked(tokenId))                 return log($("verifyLog"), "ì‹¤íŒ¨: REVOKED");
        if (Number(await nft.expiresAt(tokenId)) <= Math.floor(Date.now()/1000))
        return log($("verifyLog"), "ì‹¤íŒ¨: EXPIRED");
        
        // UI â†’ public/private
        const nations = Array.from(document.querySelectorAll(".nationOpt")).map(s => s.value || "0").slice(0,5);
        const publicInputsObj = {
            age_check_flag: $("ageFlag").value,
            required_age:    $("reqAge").value || "0",
            gender_check_flag: $("genderFlag").value,
            required_gender:   $("reqGender").value,
            nationality_check_flag: $("nationFlag").value,
            required_country_codes: nations
        };
        const priv = {
            prover_age: $("pvAge").value || "0",
            prover_gender: $("pvGender").value,
            prover_country_code: $("pvNation").value
        };
        
        const policyHash = ethers.keccak256(ethers.toUtf8Bytes($("policyStr").value || "poc"));
        const nullifier  = "0x" + "0".repeat(64); // PoC
        
        try {
            $("btnVerify").disabled = true;
            log($("verifyLog"), "ì¦ëª…/ê²€ì¦ ì¤€ë¹„ ì¤‘â€¦");
            
            let a,b,c,publicSignals;
            
            if ($("proveMode").value === "upload") {
                // âœ… ì—…ë¡œë“œ íŒŒì¼ë„ ë°˜ë“œì‹œ exportSolidityCallDataë¥¼ í†µí•´ íŒŒì‹±
                const pub = await (async () => {
                    const f = $("filePublic").files?.[0];
                    if (!f) throw new Error("public.json í•„ìš”");
                    return JSON.parse(await f.text());
                })();
                const prf = await (async () => {
                    const f = $("fileProof").files?.[0];
                    if (!f) throw new Error("proof.json í•„ìš”");
                    return JSON.parse(await f.text());
                })();
                
                const proofObj   = prf.proof ?? prf;
                const pubSignals = pub.publicSignals ?? pub;
                const calldata   = await snarkjs.groth16.exportSolidityCallData(proofObj, pubSignals);
                const parsed     = parseSolidityCalldata(calldata);
                
                a = parsed.a; b = parsed.b; c = parsed.c;
                publicSignals = parsed.inputs;
                
            } else {
                // ë¸Œë¼ìš°ì €ì—ì„œ ì¦ëª… ìƒì„±
                if (!window.snarkjs) throw new Error("snarkjs ë¡œë“œ ì‹¤íŒ¨");
                
                const input = {
                    // private
                    prover_age: priv.prover_age,
                    prover_gender: priv.prover_gender,
                    prover_country_code: priv.prover_country_code,
                    // public â€” íšŒë¡œ ì„ ì–¸ ìˆœì„œì™€ ë™ì¼
                    age_check_flag: publicInputsObj.age_check_flag,
                    required_age: publicInputsObj.required_age,
                    gender_check_flag: publicInputsObj.gender_check_flag,
                    required_gender: publicInputsObj.required_gender,
                    nationality_check_flag: publicInputsObj.nationality_check_flag,
                    required_country_codes: publicInputsObj.required_country_codes
                };
                
                const { proof, publicSignals: pubS } = await snarkjs.groth16.fullProve(
                input,
                "../zk/access_control.wasm",
                "../zk/access_control_0001.zkey"
                );
                
                const calldata = await snarkjs.groth16.exportSolidityCallData(proof, pubS);
                const parsed   = parseSolidityCalldata(calldata);
                
                a = parsed.a; b = parsed.b; c = parsed.c;
                publicSignals = parsed.inputs;
            }
            
            // âœ… publicSignals ê¸¸ì´ ê²€ì¦
            if (publicSignals.length !== 11) {
                return log($("verifyLog"), `ì‹¤íŒ¨: publicSignals length mismatch (${publicSignals.length} != 9)`);
            }
            
            // ë””ë²„ê·¸ ë¡œê¹…(ì£¼ì†Œ/ì…‹ í™•ì¸)
            console.debug("Verifier:", ADDR.PolicyVerifierA);
            console.debug("NFT:", ADDR.IdentityNFT);
            console.debug("a,b,c:", a,b,c);
            console.debug("publicSignals:", publicSignals);
            
            // âœ… íŠ¸xn ë³´ë‚´ê¸° ì „ì— staticCallë¡œ ì´ìœ  í™•ì¸ (ethers v6)
            try {
                await pv.verifyAndEmit.staticCall(tokenId, publicSignals, { a,b,c }, policyHash, nullifier);
            } catch (sim) {
                const msg = sim?.shortMessage || sim?.reason || sim?.message || "staticCall reverted";
                console.warn("staticCall revert:", sim);
                return log($("verifyLog"), `ì‹¤íŒ¨(static): ${msg}`);
            }
            
            log($("verifyLog"), "verifyAndEmit íŠ¸ëœì­ì…˜ ì „ì†¡â€¦");
            const tx = await pv.verifyAndEmit(tokenId, publicSignals, { a,b,c }, policyHash, nullifier);
            const rc = await tx.wait();
            const ev = rc.logs?.find(l => l.fragment?.name === "Verified");
            log($("verifyLog"), ev ? `ì„±ê³µ: tokenId=${ev.args.tokenId.toString()} tx=${rc.hash}` : `ì™„ë£Œ(tx=${rc.hash})`);
            
        } catch (e) {
            const msg = e?.shortMessage || e?.reason || e?.message || "execution reverted";
            console.error(e);
            log($("verifyLog"), `ì‹¤íŒ¨: ${msg}`);
        } finally {
            $("btnVerify").disabled = false;
        }
    };
    
</script>
</body>
</html>
